<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é»„é‡‘ä»·æ ¼å®æ—¶ç›‘æ§</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€â”€ Reset & Tokens â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --gold:        #C8960C;
  --gold-hover:  #A87A08;
  --gold-light:  #FDF8EC;
  --gold-border: #E8C94A;
  --gold-line:   rgba(200,150,12,0.18);

  --bg:          #F4F3EE;
  --card:        #FFFFFF;
  --header-bg:   #1A1A2E;

  --text:        #1A1A2E;
  --text-2:      #55556A;
  --text-3:      #9090A8;

  --up:          #059669;
  --up-bg:       #D1FAE5;
  --dn:          #DC2626;
  --dn-bg:       #FEE2E2;
  --flat-bg:     #F3F4F6;

  --border:      #E5E5E0;
  --radius:      14px;
  --radius-sm:   8px;
  --shadow:      0 2px 8px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-lg:   0 8px 24px rgba(0,0,0,0.10), 0 2px 6px rgba(0,0,0,0.06);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
               'PingFang SC', 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
}

/* â”€â”€â”€ Header â”€â”€â”€ */
.header {
  background: var(--header-bg);
  padding: 18px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.hd-brand { display: flex; align-items: center; gap: 12px; }
.hd-icon {
  width: 42px; height: 42px;
  background: linear-gradient(135deg, #C8960C 0%, #F5DA8A 100%);
  border-radius: 11px;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; flex-shrink: 0;
}
.hd-title { color: #fff; font-size: 18px; font-weight: 700; letter-spacing: -0.2px; }
.hd-sub   { color: #7A7A98; font-size: 12px; margin-top: 1px; }

.hd-right { display: flex; align-items: center; gap: 10px; }
.status-pill {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 20px; padding: 5px 13px;
  font-size: 12px; color: #BCBCD0;
}
.dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: #22C55E;
  animation: blink 2.2s ease-in-out infinite;
}
.dot.err { background: #EF4444; animation: none; }
.dot.loading { background: #F59E0B; animation: blink 0.8s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.35} }

/* â”€â”€â”€ Main â”€â”€â”€ */
.main {
  max-width: 1200px;
  margin: 0 auto;
  padding: 22px 20px 48px;
}

/* â”€â”€â”€ Toolbar â”€â”€â”€ */
.toolbar {
  display: flex; align-items: center;
  justify-content: space-between;
  gap: 10px; flex-wrap: wrap;
  margin-bottom: 18px;
}
.unit-toggle {
  display: flex;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 3px; gap: 2px;
}
.unit-btn {
  padding: 6px 16px;
  border: none; background: transparent;
  border-radius: 6px;
  font-size: 13px; font-weight: 500;
  color: var(--text-2); cursor: pointer;
  transition: all .15s;
  white-space: nowrap;
}
.unit-btn.active { background: var(--gold); color: #fff; }
.unit-btn:not(.active):hover { background: var(--bg); }

.refresh-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 14px;
  border: 1px solid var(--border);
  background: var(--card);
  border-radius: var(--radius-sm);
  font-size: 13px; color: var(--text-2);
  cursor: pointer; transition: all .15s;
}
.refresh-btn:hover { border-color: var(--gold); color: var(--gold); }
.refresh-btn.spinning svg { animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.refresh-btn svg { flex-shrink: 0; transition: transform .5s; }

/* â”€â”€â”€ Cards â”€â”€â”€ */
.cards {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  margin-bottom: 20px;
  position: relative;
}
@media (max-width: 900px) { .cards { grid-template-columns: 1fr; } }
@media (max-width: 680px) { .cards { grid-template-columns: 1fr; } }

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px 18px;
  box-shadow: var(--shadow);
  position: relative; overflow: hidden;
  transition: box-shadow .2s, transform .2s;
}
.card:hover { box-shadow: var(--shadow-lg); transform: translateY(-1px); }

/* Gold accent bar top */
.card::after {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
}
.card.primary { background: var(--gold-light); border-color: var(--gold-border); }
.card.primary::after {
  background: linear-gradient(90deg, var(--gold), var(--gold-border));
}

.card-tag {
  font-size: 11px; font-weight: 700;
  letter-spacing: .7px; text-transform: uppercase;
  color: var(--text-3); margin-bottom: 2px;
}
.card-date { font-size: 11px; color: var(--text-3); margin-bottom: 12px; min-height: 16px; }

.card-price {
  font-size: 30px; font-weight: 700;
  letter-spacing: -0.6px; line-height: 1.1;
  color: var(--text);
  min-height: 36px;
}
.card.primary .card-price { color: var(--gold); }

.card-price-sub {
  font-size: 13px; color: var(--text-3);
  margin-top: 3px; min-height: 18px;
}

.card-changes {
  display: flex; align-items: center; flex-wrap: wrap;
  gap: 6px; margin-top: 10px;
}
.badge {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 3px 8px; border-radius: 6px;
  font-size: 12px; font-weight: 600;
  white-space: nowrap;
}
.badge.up   { background: var(--up-bg);   color: var(--up); }
.badge.dn   { background: var(--dn-bg);   color: var(--dn); }
.badge.flat { background: var(--flat-bg); color: var(--text-3); }
.change-note { font-size: 11px; color: var(--text-3); }

/* â”€â”€â”€ Chart section â”€â”€â”€ */
.chart-wrap {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px 22px 18px;
  box-shadow: var(--shadow);
  position: relative;
}
.chart-head {
  display: flex; align-items: flex-start;
  justify-content: space-between;
  gap: 12px; flex-wrap: wrap;
  margin-bottom: 18px;
}
.chart-title { font-size: 15px; font-weight: 600; }
.chart-sub   { font-size: 12px; color: var(--text-3); margin-top: 2px; }

.range-tabs {
  display: flex;
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 3px; gap: 2px;
}
.rtab {
  padding: 5px 14px;
  border: none; background: transparent;
  border-radius: 6px;
  font-size: 13px; font-weight: 500;
  color: var(--text-2); cursor: pointer;
  transition: all .15s;
}
.rtab.active { background: var(--card); color: var(--gold); box-shadow: var(--shadow); }
.rtab:not(.active):hover { background: rgba(200,150,12,.08); color: var(--gold); }

.chart-box { position: relative; height: 300px; }

.chart-footer {
  margin-top: 10px;
  display: flex; justify-content: space-between; flex-wrap: wrap; gap: 4px;
}
.chart-note { font-size: 11px; color: var(--text-3); }

/* â”€â”€â”€ Loading overlay â”€â”€â”€ */
.loader {
  display: none; position: absolute; inset: 0;
  background: rgba(255,255,255,.75);
  align-items: center; justify-content: center;
  border-radius: var(--radius); z-index: 10;
}
.loader.on { display: flex; }
.spinner {
  width: 30px; height: 30px;
  border: 3px solid #F5E6A3;
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin .7s linear infinite;
}

/* â”€â”€â”€ Skeleton â”€â”€â”€ */
.skel {
  background: linear-gradient(90deg,#eee 25%,#ddd 50%,#eee 75%);
  background-size: 200% 100%;
  animation: shimmer 1.4s infinite;
  border-radius: 6px; display: inline-block;
}
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* â”€â”€â”€ Exchange rate strip â”€â”€â”€ */
.rate-strip {
  display: flex; align-items: center; gap: 20px;
  padding: 8px 14px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 18px;
  font-size: 12px; color: var(--text-2);
  flex-wrap: wrap;
}
.rate-strip span { color: var(--text-3); }
.rate-strip strong { color: var(--text); }

/* â”€â”€â”€ Error bar â”€â”€â”€ */
.err-bar {
  display: none;
  background: #FEF2F2; border: 1px solid #FECACA;
  border-radius: var(--radius-sm); padding: 10px 14px;
  font-size: 12px; color: var(--dn);
  margin-bottom: 14px;
}
.err-bar.on { display: block; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header">
  <div class="hd-brand">
    <div class="hd-icon">ğŸª™</div>
    <div>
      <div class="hd-title">é»„é‡‘ä»·æ ¼å®æ—¶ç›‘æ§</div>
      <div class="hd-sub">Gold Price Monitor Â· å‚è€ƒä¸Šæµ·é»„é‡‘äº¤æ˜“æ‰€ Â· æ•°æ®å»¶è¿Ÿçº¦15åˆ†é’Ÿ</div>
    </div>
  </div>
  <div class="hd-right">
    <div class="status-pill">
      <div class="dot loading" id="statusDot"></div>
      <span id="statusText">æ­£åœ¨åŠ è½½â€¦</span>
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="main">

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="unit-toggle">
      <button class="unit-btn active" id="btnCNY" onclick="setUnit('CNY')">äººæ°‘å¸/å…‹ &nbsp;CNY/g</button>
      <button class="unit-btn"        id="btnUSD" onclick="setUnit('USD')">ç¾å…ƒ/ç›å¸ USD/oz</button>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">
      <svg id="refreshIcon" width="13" height="13" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
      </svg>
      åˆ·æ–°æ•°æ®
    </button>
  </div>

  <!-- Exchange rate / timestamp strip -->
  <div class="rate-strip" id="rateStrip">
    <span>USD/CNY æ±‡ç‡ï¼š</span><strong id="rateVal">--</strong>
    <span>ï½œ</span>
    <span>troy oz â†’ å…‹ï¼š</span><strong>1 oz = 31.1035 g</strong>
    <span>ï½œ</span>
    <span>æœ€åæ›´æ–°ï¼š</span><strong id="lastUpdate">--</strong>
    <span style="margin-left:auto">æ¯60ç§’è‡ªåŠ¨åˆ·æ–°</span>
  </div>

  <!-- Error bar -->
  <div class="err-bar" id="errBar">âš ï¸ <span id="errMsg"></span></div>

  <!-- Cards -->
  <div class="cards">
    <div class="loader" id="cardLoader"><div class="spinner"></div></div>

    <!-- Card 1: Real-time -->
    <div class="card primary">
      <div class="card-tag">å®æ—¶é‡‘ä»·</div>
      <div class="card-date" id="c1date">--</div>
      <div class="card-price" id="c1price">--</div>
      <div class="card-price-sub" id="c1priceSub">--</div>
      <div class="card-changes">
        <span class="badge flat" id="c1abs">--</span>
        <span class="badge flat" id="c1pct">--</span>
        <span class="change-note">è¾ƒä¸Šä¸€äº¤æ˜“æ—¥æ”¶ç›˜</span>
      </div>
    </div>

    <!-- Card 2: Previous trading day close -->
    <div class="card">
      <div class="card-tag">ä¸Šä¸€äº¤æ˜“æ—¥æ”¶ç›˜</div>
      <div class="card-date" id="c2date">--</div>
      <div class="card-price" id="c2price">--</div>
      <div class="card-price-sub" id="c2priceSub">--</div>
      <div class="card-changes">
        <span class="badge flat" id="c2abs">--</span>
        <span class="badge flat" id="c2pct">--</span>
        <span class="change-note">ä¸å½“å‰ä»·å·®</span>
      </div>
    </div>

    <!-- Card 3: Same weekday last week -->
    <div class="card">
      <div class="card-tag">ä¸Šå‘¨åŒæ—¥æ”¶ç›˜</div>
      <div class="card-date" id="c3date">--</div>
      <div class="card-price" id="c3price">--</div>
      <div class="card-price-sub" id="c3priceSub">--</div>
      <div class="card-changes">
        <span class="badge flat" id="c3abs">--</span>
        <span class="badge flat" id="c3pct">--</span>
        <span class="change-note">ä¸å½“å‰ä»·å·®</span>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-wrap">
    <div class="loader" id="chartLoader"><div class="spinner"></div></div>
    <div class="chart-head">
      <div>
        <div class="chart-title" id="chartTitle">ä»·æ ¼èµ°åŠ¿</div>
        <div class="chart-sub" id="chartSub">å†å²æ”¶ç›˜ä»·æ ¼</div>
      </div>
      <div class="range-tabs">
        <button class="rtab"        id="tab1wk" onclick="setRange('1wk')">1å‘¨</button>
        <button class="rtab active" id="tab1mo" onclick="setRange('1mo')">1æœˆ</button>
        <button class="rtab"        id="tab3mo" onclick="setRange('3mo')">3æœˆ</button>
        <button class="rtab"        id="tab6mo" onclick="setRange('6mo')">6æœˆ</button>
      </div>
    </div>
    <div class="chart-box"><canvas id="goldChart"></canvas></div>
    <div class="chart-footer">
      <span class="chart-note">æ•°æ®æ¥æºï¼šYahoo Finance (GC=F) | ä»·æ ¼ä¸ºç¾ä¸œæ”¶ç›˜ä»·è½¬æ¢</span>
      <span class="chart-note" id="chartPoints"></span>
    </div>
  </div>

</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var OZ = 31.1035;
var REFRESH_MS = 60000;

var GP  = 'https://data-asg.goldprice.org/dbXRates/';
var YF1 = 'https://query1.finance.yahoo.com/v8/finance/chart/';
var YF2 = 'https://query2.finance.yahoo.com/v8/finance/chart/';

// goldprice.org has native CORS â†’ direct first, then proxies
function gpUrls(suffix) {
  var u = GP + suffix, e = encodeURIComponent(u);
  return [
    u,
    'https://corsproxy.io/?' + e,
    'https://api.allorigins.win/raw?url=' + e,
    'https://thingproxy.freeboard.io/fetch/' + u
  ];
}
// Yahoo Finance has NO CORS â†’ proxies only, query1 + query2 for each
function yfUrls(path) {
  var u1 = YF1 + path, u2 = YF2 + path;
  var e1 = encodeURIComponent(u1), e2 = encodeURIComponent(u2);
  return [
    'https://corsproxy.io/?' + e1,
    'https://corsproxy.io/?' + e2,
    'https://api.allorigins.win/raw?url=' + e1,
    'https://api.allorigins.win/raw?url=' + e2,
    'https://thingproxy.freeboard.io/fetch/' + u1,
    'https://thingproxy.freeboard.io/fetch/' + u2,
    'https://api.codetabs.com/v1/proxy?quest=' + u1,
    'https://api.codetabs.com/v1/proxy?quest=' + u2
  ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var unit  = 'CNY';
var range = '1mo';
var timer = null;
var chart = null;
var rateCache = null;  // date-key â†’ USD/CNY rate, populated once from 6mo data

var data = {
  rtUSD: null, rtCNY: null,
  pc:    null,   // { usd, cny, label, src }
  lw:    null,   // { usd, cny, label }
  rate:  null,
  hist:  {}      // range â†’ { labels, usd[], cny[] }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH: safeFetch + fetchRace
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Compatible timeout: AbortController + setTimeout (NOT AbortSignal.timeout)
function safeFetch(url, ms) {
  ms = ms || 10000;
  return new Promise(function(resolve, reject) {
    var ctrl = new AbortController();
    var tid = setTimeout(function() { ctrl.abort(); }, ms);
    fetch(url, { signal: ctrl.signal, cache: 'no-cache',
                 headers: { 'Accept': 'application/json, */*' } })
      .then(function(res) {
        clearTimeout(tid);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(resolve)
      .catch(function(e) { clearTimeout(tid); reject(e); });
  });
}

// SPEED FIX: Race first 4 proxies simultaneously; if all fail, try remainder sequentially.
// This avoids waiting 8â€“10 s per sequential attempt when early proxies are down.
function fetchRace(urls, label) {
  return new Promise(function(resolve, reject) {
    var done    = false;
    var fast    = urls.slice(0, 4);
    var rest    = urls.slice(4);
    var pending = fast.length;

    function tryRest(idx) {
      if (done || idx >= rest.length) {
        if (!done) reject(new Error('All failed: ' + (label || '')));
        return;
      }
      safeFetch(rest[idx], 10000)
        .then(function(d) { if (!done) { done = true; resolve(d); } })
        .catch(function()  { tryRest(idx + 1); });
    }

    if (pending === 0) { tryRest(0); return; }

    fast.forEach(function(url) {
      safeFetch(url, 8000)
        .then(function(d) { if (!done) { done = true; resolve(d); } })
        .catch(function(e) {
          console.warn('[gold] proxy fail:', url.slice(0, 60), e.message);
          pending--;
          if (pending === 0 && !done) tryRest(0);
        });
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REAL-TIME PRICE  (goldprice.org â†’ cards 1 & 2 immediately)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRealtime() {
  // Primary: goldprice.org (native CORS, very fast)
  try {
    var dCNY = await fetchRace(gpUrls('CNY'), 'gp-CNY');
    var dUSD = await fetchRace(gpUrls('USD'), 'gp-USD');
    var iC = dCNY.items[0], iU = dUSD.items[0];
    var cnyOz = iC.xauPrice, usdOz = iU.xauPrice;

    data.rtCNY = cnyOz / OZ;
    data.rtUSD = usdOz;
    data.rate  = usdOz > 0 ? cnyOz / usdOz : (data.rate || 7.2);

    // Derive prev close: prevClose = current / (1 + pcXau/100)
    if (data.pc === null && iC.pcXau != null && iU.pcXau != null) {
      data.pc = {
        cny: (cnyOz / (1 + iC.pcXau / 100)) / OZ,
        usd:  usdOz / (1 + iU.pcXau / 100),
        label: 'å‰ä¸€äº¤æ˜“æ—¥', src: 'gp'
      };
    }
    return true;
  } catch(e) { console.error('[gold] gp failed:', e.message); }

  // Fallback: Yahoo Finance via proxy
  try {
    var dG = await fetchRace(yfUrls('GC%3DF?interval=1d&range=5d'),    'yf-rt-gold');
    var dR = await fetchRace(yfUrls('USDCNY%3DX?interval=1d&range=5d'), 'yf-rt-rate');
    var meta = dG.chart.result[0].meta;
    var rate = dR.chart.result[0].meta.regularMarketPrice;
    var usdOz = meta.regularMarketPrice;

    data.rtUSD = usdOz;
    data.rtCNY = (usdOz * rate) / OZ;
    data.rate  = rate;

    if (data.pc === null) {
      var prevU = meta.previousClose || meta.chartPreviousClose;
      if (prevU) data.pc = { usd: prevU, cny: (prevU * rate) / OZ, label: 'å‰ä¸€äº¤æ˜“æ—¥', src: 'yf' };
    }
    return true;
  } catch(e) { console.error('[gold] YF rt failed:', e.message); return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORICAL DATA â€” rate cache + gold processing
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Build global rate map from USDCNY response (called ONCE, covers all ranges)
function buildRateCache(dR) {
  var ts = dR.chart.result[0].timestamp;
  var cl = dR.chart.result[0].indicators.quote[0].close;
  rateCache = {};
  ts.forEach(function(t, i) { if (cl[i] != null) rateCache[dateKey(t)] = cl[i]; });
}

// Convert a gold chart response into rows using the cached rate map
function processGoldData(dG, fetchRange) {
  var stamps = dG.chart.result[0].timestamp;
  var closes = dG.chart.result[0].indicators.quote[0].close;
  var lastR  = data.rate || 7.2;
  var rows   = [];

  stamps.forEach(function(ts, i) {
    if (closes[i] == null) return;
    var k = dateKey(ts);
    var r = (rateCache && rateCache[k]) ? rateCache[k] : lastR;
    if (rateCache && rateCache[k]) lastR = r;
    rows.push({
      label: fmtDateLabel(ts),
      usd:   +closes[i].toFixed(2),
      cny:   +((closes[i] * r) / OZ).toFixed(2)
    });
  });

  if (!rows.length) throw new Error('empty gold data');

  var N  = rows.length;
  var sl = function(n) { return n ? rows.slice(-n) : rows.slice(); };
  var toH = function(arr) {
    return {
      labels: arr.map(function(r) { return r.label; }),
      usd:    arr.map(function(r) { return r.usd; }),
      cny:    arr.map(function(r) { return r.cny; })
    };
  };

  // Always populate 1wk + 1mo (we always fetch at least 1mo of gold data)
  data.hist['1wk'] = toH(sl(7));
  data.hist['1mo'] = toH(sl(23));
  if (fetchRange === '3mo' || fetchRange === '6mo') data.hist['3mo'] = toH(sl(65));
  if (fetchRange === '6mo')                          data.hist['6mo'] = toH(sl(0));

  // Refine prev close with actual date label from historical data
  if (!data.pc || data.pc.src === 'gp') {
    var last = rows[N - 1];
    data.pc = { usd: last.usd, cny: last.cny, label: last.label, src: 'hist' };
  }
  // Last week same day (~5 trading days back)
  if (!data.lw && N >= 6) {
    var lw = rows[N - 6];
    data.lw = { usd: lw.usd, cny: lw.cny, label: lw.label };
  }
  if (!data.rate && lastR) data.rate = lastR;
}

// INITIAL: fetch gold 1mo (required) + rate 6mo (optional, background)
// FIX: Promise.all caused full failure if EITHER fetch failed (USDCNY is NOT
// required â€” processGoldData falls back to data.rate spot rate automatically).
async function loadInitialHistory() {
  showChartLoader(true);
  try {
    // â”€â”€ Step 1: Gold data (required for chart & card 3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var dG = await fetchRace(
      yfUrls('GC%3DF?interval=1d&range=1mo&includePrePost=false'), 'gold-1mo'
    );

    // â”€â”€ Step 2: Rate cache (optional â€” fires in background, doesn't block) â”€â”€
    // If it succeeds before processGoldData we use per-day rates (more accurate).
    // If it fails or arrives late, processGoldData uses data.rate (spot rate, fine).
    var ratePromise = rateCache ? Promise.resolve(null)
      : fetchRace(yfUrls('USDCNY%3DX?interval=1d&range=6mo'), 'rate-6mo')
          .then(buildRateCache)
          .catch(function(e) {
            console.warn('[gold] rate cache skipped, using spot rate:', e.message);
          });

    // Try to get rate before processing gold (gives ~0 extra latency if both
    // resolve quickly; we cap the rate wait at 3 s so chart never stalls).
    await Promise.race([ratePromise, new Promise(function(r){ setTimeout(r, 3000); })]);

    // â”€â”€ Step 3: Build chart data (rate may or may not be cached yet) â”€â”€â”€â”€â”€â”€
    processGoldData(dG, '1mo');
    return true;
  } catch(e) {
    console.error('[gold] loadInitialHistory failed:', e.message);
    showChartFailed('å†å²æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»"é‡æ–°åŠ è½½"é‡è¯•ã€‚');
    return false;
  } finally {
    showChartLoader(false);
  }
}

// ON-DEMAND: fetch gold only for larger ranges (rate already cached)
async function loadRangeHistory(r) {
  if (data.hist[r]) return true;
  showChartLoader(true);
  try {
    var dG = await fetchRace(
      yfUrls('GC%3DF?interval=1d&range=' + r + '&includePrePost=false'), 'gold-' + r
    );
    processGoldData(dG, r);
    return true;
  } catch(e) {
    console.error('[gold] range history failed:', r, e.message);
    showChartFailed('åŠ è½½ ' + rangeLabel(r) + ' æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
    return false;
  } finally {
    showChartLoader(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dateKey(ts) {
  var d = new Date(ts * 1000);
  return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
}
function pad(n) { return String(n).padStart(2, '0'); }
function fmtDateLabel(ts) {
  var d = new Date(ts * 1000);
  return (d.getMonth()+1) + '/' + d.getDate();
}
function nowBJT() {
  return new Date().toLocaleString('zh-CN', {
    timeZone: 'Asia/Shanghai',
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtPrice(cny, usd) {
  if (unit === 'CNY') return cny == null ? '--' : 'Â¥\u2009' + cny.toFixed(2);
  return usd == null ? '--' : '$\u2009' + usd.toFixed(2);
}
function fmtSub(cny, usd) {
  if (unit === 'CNY') return usd == null ? '' : 'â‰ˆ $\u2009' + usd.toFixed(2) + '\u2009/ oz';
  return cny == null ? '' : 'â‰ˆ Â¥\u2009' + cny.toFixed(2) + '\u2009/ å…‹';
}
function fmtUnit() { return unit === 'CNY' ? 'CNY/g' : 'USD/oz'; }
function fmtDiff(val) {
  if (val == null || isNaN(val)) return '--';
  var sign = val >= 0 ? '+' : '';
  var u = unit === 'CNY' ? ' å…ƒ/å…‹' : ' USD/oz';
  return sign + val.toFixed(2) + u;
}
function fmtPct(val) {
  if (val == null || isNaN(val)) return '--';
  return (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BADGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function badge(id, absVal) {
  var el = document.getElementById(id);
  if (absVal == null || isNaN(absVal)) { el.className='badge flat'; el.textContent='--'; return; }
  var up = absVal >= 0;
  el.className = 'badge ' + (up ? 'up' : 'dn');
  el.textContent = (up ? 'â–² ' : 'â–¼ ') + fmtDiff(absVal);
}
function badgePct(id, pctVal) {
  var el = document.getElementById(id);
  if (pctVal == null || isNaN(pctVal)) { el.className='badge flat'; el.textContent='--'; return; }
  var up = pctVal >= 0;
  el.className = 'badge ' + (up ? 'up' : 'dn');
  el.textContent = (up ? 'â–² ' : 'â–¼ ') + fmtPct(pctVal);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCards() {
  var rt  = unit === 'CNY' ? data.rtCNY  : data.rtUSD;
  var pcV = unit === 'CNY' ? (data.pc && data.pc.cny) : (data.pc && data.pc.usd);
  var lwV = unit === 'CNY' ? (data.lw && data.lw.cny) : (data.lw && data.lw.usd);

  // Card 1 â€“ real-time
  document.getElementById('c1price').textContent    = fmtPrice(data.rtCNY, data.rtUSD);
  document.getElementById('c1priceSub').textContent = fmtSub(data.rtCNY, data.rtUSD);
  document.getElementById('c1date').textContent     = 'åŒ—äº¬æ—¶é—´ ' + nowBJT();
  if (rt != null && pcV != null) {
    var abs1 = rt - pcV, pct1 = abs1 / pcV * 100;
    badge('c1abs', abs1); badgePct('c1pct', pct1);
  }

  // Card 2 â€“ prev close
  document.getElementById('c2price').textContent    = fmtPrice(data.pc && data.pc.cny, data.pc && data.pc.usd);
  document.getElementById('c2priceSub').textContent = fmtSub(data.pc && data.pc.cny, data.pc && data.pc.usd);
  document.getElementById('c2date').textContent     = data.pc ? data.pc.label + 'ï¼ˆä¸Šä¸€äº¤æ˜“æ—¥ï¼‰' : '--';
  if (rt != null && pcV != null) {
    var abs2 = pcV - rt, pct2 = abs2 / rt * 100;
    badge('c2abs', abs2); badgePct('c2pct', pct2);
  }

  // Card 3 â€“ last week same day
  document.getElementById('c3price').textContent    = fmtPrice(data.lw && data.lw.cny, data.lw && data.lw.usd);
  document.getElementById('c3priceSub').textContent = fmtSub(data.lw && data.lw.cny, data.lw && data.lw.usd);
  document.getElementById('c3date').textContent     = data.lw ? data.lw.label + 'ï¼ˆä¸Šå‘¨åŒæ—¥ï¼‰' : 'ç­‰å¾…å†å²æ•°æ®â€¦';
  if (rt != null && lwV != null) {
    var abs3 = lwV - rt, pct3 = abs3 / rt * 100;
    badge('c3abs', abs3); badgePct('c3pct', pct3);
  }

  // Rate strip
  document.getElementById('rateVal').textContent    = data.rate ? data.rate.toFixed(4) : '--';
  document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChart() {
  var h = data.hist[range];
  if (!h) return;

  var prices = unit === 'CNY' ? h.cny : h.usd;
  var labels = h.labels;
  var pts    = labels.length;

  document.getElementById('chartTitle').textContent =
    'ä»·æ ¼èµ°åŠ¿ï¼ˆ' + (unit === 'CNY' ? 'äººæ°‘å¸/å…‹' : 'ç¾å…ƒ/ç›å¸') + 'ï¼‰';
  document.getElementById('chartSub').textContent =
    rangeLabel(range) + ' Â· ' + pts + ' ä¸ªäº¤æ˜“æ—¥';
  document.getElementById('chartPoints').textContent = 'å…± ' + pts + ' ä¸ªæ•°æ®ç‚¹';

  var COLOR = '#C8960C', COLOR_A = 'rgba(200,150,12,0.10)';
  var makeTtLabel = function() {
    return function(ctx) {
      var v = ctx.raw;
      return unit === 'CNY' ? '  Â¥ ' + v.toFixed(2) + ' / å…‹' : '  $ ' + v.toFixed(2) + ' / oz';
    };
  };
  var makeYTick = function() {
    return function(v) { return unit === 'CNY' ? 'Â¥' + v.toFixed(0) : '$' + v.toFixed(0); };
  };

  if (!chart) {
    var ctx = document.getElementById('goldChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: fmtUnit(), data: prices,
          borderColor: COLOR, backgroundColor: COLOR_A,
          borderWidth: 2, fill: true,
          pointRadius: pts > 60 ? 0 : pts > 30 ? 2 : 3,
          pointHoverRadius: 5, pointHoverBackgroundColor: COLOR,
          tension: 0.25
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        animation: { duration: 400 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(26,26,46,0.92)',
            titleColor: '#BCBCD0', bodyColor: '#FFF', padding: 10,
            callbacks: { label: makeTtLabel() }
          }
        },
        scales: {
          x: {
            grid: { display: false }, border: { color: '#E5E5E0' },
            ticks: { color: '#9090A8', font: { size: 11 }, maxTicksLimit: 8, maxRotation: 0 }
          },
          y: {
            position: 'right', grid: { color: 'rgba(0,0,0,0.04)' },
            border: { color: 'transparent' },
            ticks: { color: '#9090A8', font: { size: 11 }, callback: makeYTick() }
          }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = prices;
    chart.data.datasets[0].label = fmtUnit();
    chart.data.datasets[0].pointRadius = pts > 60 ? 0 : pts > 30 ? 2 : 3;
    chart.options.plugins.tooltip.callbacks.label = makeTtLabel();
    chart.options.scales.y.ticks.callback = makeYTick();
    chart.update();
  }
}

function rangeLabel(r) {
  return { '1wk': 'è¿‘1å‘¨', '1mo': 'è¿‘1æœˆ', '3mo': 'è¿‘3æœˆ', '6mo': 'è¿‘6æœˆ' }[r] || r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCardLoader(v)  { document.getElementById('cardLoader').classList.toggle('on', v); }
function showChartLoader(v) { document.getElementById('chartLoader').classList.toggle('on', v); }

function showError(msg) {
  document.getElementById('errBar').classList.add('on');
  document.getElementById('errMsg').textContent = msg;
}
function clearError() { document.getElementById('errBar').classList.remove('on'); }

function showChartFailed(msg) {
  var box = document.getElementById('goldChart').parentNode;
  var existing = box.querySelector('.chart-empty-msg');
  if (!existing) {
    var div = document.createElement('div');
    div.className = 'chart-empty-msg';
    div.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;' +
      'justify-content:center;flex-direction:column;gap:8px;color:#9090A8;font-size:13px;' +
      'background:#FAFAF8;border-radius:8px;text-align:center;padding:20px;';
    div.innerHTML = '<span style="font-size:28px">ğŸ“Š</span><span>' + msg + '</span>' +
      '<button onclick="manualRefresh()" style="margin-top:4px;padding:6px 16px;' +
      'border:1px solid #E5E5E0;border-radius:6px;background:#fff;cursor:pointer;' +
      'font-size:12px;color:#C8960C;">é‡æ–°åŠ è½½</button>';
    box.appendChild(div);
  }
}

function setStatus(state, text) {
  document.getElementById('statusDot').className = 'dot ' + state;
  document.getElementById('statusText').textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNIT & RANGE CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setUnit(u) {
  unit = u;
  document.getElementById('btnCNY').classList.toggle('active', u === 'CNY');
  document.getElementById('btnUSD').classList.toggle('active', u === 'USD');
  renderCards();
  renderChart();
}
function setRange(r) {
  range = r;
  ['1wk','1mo','3mo','6mo'].forEach(function(x) {
    document.getElementById('tab' + x).classList.toggle('active', x === r);
  });

  if (data.hist[r]) {
    // Data already cached â†’ instant render
    renderChart();
  } else {
    // Lazy-load this range (only gold data; rate already cached from init)
    (async function() {
      var ok = await loadRangeHistory(r);
      if (ok) { renderChart(); renderCards(); }
    })();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll(isManual) {
  clearError();
  if (isManual) {
    Object.assign(data, { rtUSD:null, rtCNY:null, pc:null, lw:null, rate:null, hist:{} });
    rateCache = null;
    var msg = document.querySelector('.chart-empty-msg');
    if (msg) msg.remove();
    if (chart) { chart.destroy(); chart = null; }
  }
  setStatus('loading', 'æ­£åœ¨æ›´æ–°â€¦');
  showCardLoader(true);

  var rtOk = await loadRealtime();
  showCardLoader(false);

  if (!rtOk) {
    setStatus('err', 'å®æ—¶ä»·æ ¼è·å–å¤±è´¥');
    showError('å®æ—¶é‡‘ä»·è·å–å¤±è´¥ã€‚å¯èƒ½åŸå› ï¼šç½‘ç»œé™åˆ¶ / APIé™æµã€‚è¯·ç¨åç‚¹å‡»"åˆ·æ–°æ•°æ®"ã€‚');
    return;
  }

  renderCards();
  setStatus('', 'å·²æ›´æ–° ' + nowBJT() + 'ï¼ˆåŒ—äº¬ï¼‰');

  // Tiered: load 1mo gold (fast) + cache 6mo rates â†’ populates card 3 + default chart
  var histOk = await loadInitialHistory();
  if (histOk) {
    renderChart();
    renderCards();  // re-render to fill card 3 (lw)
  }
}

async function manualRefresh() {
  var btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  await loadAll(true);
  btn.classList.remove('spinning');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO-REFRESH (soft â€“ only real-time price)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startAutoRefresh() {
  clearInterval(timer);
  timer = setInterval(async function() {
    var ok = await loadRealtime();
    if (ok) { renderCards(); setStatus('', 'å·²æ›´æ–° ' + nowBJT() + 'ï¼ˆåŒ—äº¬ï¼‰'); }
  }, REFRESH_MS);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function() {
  await loadAll(false);
  startAutoRefresh();
})();
</script>
</body>
</html>
